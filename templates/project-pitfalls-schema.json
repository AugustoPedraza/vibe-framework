{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Project Pitfalls",
  "description": "Persistent per-project memory of common mistakes to prevent repeat errors",
  "type": "object",
  "required": ["pitfalls"],
  "properties": {
    "project_name": {
      "type": "string",
      "description": "Human-readable project name"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "When pitfalls were last updated"
    },
    "pitfalls": {
      "type": "array",
      "description": "List of known pitfalls for this project",
      "items": {
        "$ref": "#/definitions/pitfall"
      }
    }
  },
  "definitions": {
    "pitfall": {
      "type": "object",
      "required": ["id", "category", "description", "check", "severity"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^PIT-[0-9]+$",
          "description": "Unique pitfall identifier (e.g., PIT-001)"
        },
        "category": {
          "type": "string",
          "enum": [
            "svelte",
            "liveview",
            "ash",
            "css",
            "ux",
            "testing",
            "elixir",
            "javascript",
            "database",
            "security",
            "other"
          ],
          "description": "Category of the pitfall"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what can go wrong"
        },
        "example": {
          "type": "string",
          "description": "Example of the error or user correction that revealed it"
        },
        "solution": {
          "type": "string",
          "description": "How to fix or avoid this pitfall"
        },
        "check": {
          "type": "object",
          "description": "How to verify this pitfall has been avoided",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["manual", "grep_pattern", "file_exists", "command"],
              "description": "Type of check to perform"
            },
            "prompt": {
              "type": "string",
              "description": "Prompt for manual checks"
            },
            "pattern": {
              "type": "string",
              "description": "Regex pattern for grep_pattern checks"
            },
            "paths": {
              "type": "array",
              "items": { "type": "string" },
              "description": "File paths/globs to search"
            },
            "should_match": {
              "type": "boolean",
              "description": "For grep_pattern: true if pattern SHOULD exist, false if it should NOT"
            },
            "file_path": {
              "type": "string",
              "description": "For file_exists: path to check"
            },
            "command": {
              "type": "string",
              "description": "For command checks: command to run"
            },
            "success_pattern": {
              "type": "string",
              "description": "For command checks: pattern indicating success"
            }
          },
          "allOf": [
            {
              "if": { "properties": { "type": { "const": "manual" } } },
              "then": { "required": ["prompt"] }
            },
            {
              "if": { "properties": { "type": { "const": "grep_pattern" } } },
              "then": { "required": ["pattern", "paths"] }
            },
            {
              "if": { "properties": { "type": { "const": "file_exists" } } },
              "then": { "required": ["file_path"] }
            },
            {
              "if": { "properties": { "type": { "const": "command" } } },
              "then": { "required": ["command"] }
            }
          ]
        },
        "severity": {
          "type": "string",
          "enum": ["blocker", "warning", "suggestion"],
          "description": "How severe this pitfall is (blocker = HARD BLOCK)"
        },
        "applies_to": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Feature types or phases this pitfall applies to"
        },
        "discovered_in": {
          "type": "string",
          "description": "Feature ID where this was discovered"
        },
        "discovered_at": {
          "type": "string",
          "format": "date",
          "description": "Date when pitfall was discovered"
        },
        "discovered_via": {
          "type": "string",
          "enum": ["manual", "human_intervention_analysis", "retro", "review"],
          "description": "How this pitfall was discovered"
        },
        "times_caught": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times this pitfall was caught before it caused an issue"
        },
        "times_missed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times this pitfall slipped through"
        }
      }
    }
  },
  "example": {
    "project_name": "Syna",
    "last_updated": "2026-01-22T10:00:00Z",
    "pitfalls": [
      {
        "id": "PIT-001",
        "category": "svelte",
        "description": "Forgetting to export new component in app.js",
        "example": "User: 'you forgot to add the component to app.js'",
        "solution": "After creating any new Svelte component, add export to assets/svelte/app.js",
        "check": {
          "type": "manual",
          "prompt": "Is the new component exported in assets/svelte/app.js?"
        },
        "severity": "blocker",
        "discovered_in": "AUTH-001",
        "discovered_at": "2026-01-20",
        "discovered_via": "human_intervention_analysis",
        "times_caught": 3,
        "times_missed": 1
      }
    ]
  }
}
