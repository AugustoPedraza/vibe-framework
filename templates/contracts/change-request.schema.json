{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Contract Change Request",
  "description": "Request to modify a locked interface contract during parallel implementation. Minor changes may be auto-approved, breaking changes require human approval.",
  "type": "object",
  "required": ["id", "feature_id", "contract_version", "requested_by", "change_type", "changes", "created_at"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Change request identifier",
      "pattern": "^CR-[A-Z]+-[0-9]+-[0-9]+$"
    },
    "feature_id": {
      "type": "string",
      "description": "Feature identifier",
      "pattern": "^[A-Z]+-[0-9]+$"
    },
    "contract_version": {
      "type": "integer",
      "description": "Current contract version being modified"
    },
    "requested_by": {
      "type": "string",
      "enum": ["backend", "frontend", "integration", "human"],
      "description": "Who requested the change"
    },
    "change_type": {
      "type": "string",
      "enum": ["minor", "breaking"],
      "description": "Severity of the change"
    },
    "auto_approve": {
      "type": "boolean",
      "description": "Whether this change can be auto-approved (minor only)"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "approved", "rejected", "applied"],
      "description": "Current status of the change request"
    },
    "changes": {
      "type": "array",
      "description": "List of proposed changes",
      "items": {
        "type": "object",
        "required": ["path", "operation", "description"],
        "properties": {
          "path": {
            "type": "string",
            "description": "JSON path to the changed element (e.g., api_contract.actions[0].inputs)"
          },
          "operation": {
            "type": "string",
            "enum": ["add", "modify", "remove"],
            "description": "Type of change"
          },
          "description": {
            "type": "string",
            "description": "Human-readable description of the change"
          },
          "before": {
            "description": "Previous value (for modify/remove)"
          },
          "after": {
            "description": "New value (for add/modify)"
          },
          "breaking_reason": {
            "type": "string",
            "description": "Why this change is breaking (if applicable)"
          }
        }
      }
    },
    "justification": {
      "type": "string",
      "description": "Why this change is necessary"
    },
    "impact_analysis": {
      "type": "object",
      "description": "Analysis of change impact on streams",
      "properties": {
        "backend_impact": {
          "type": "string",
          "enum": ["none", "minor_update", "significant_rework", "restart_required"],
          "description": "Impact on backend stream"
        },
        "frontend_impact": {
          "type": "string",
          "enum": ["none", "minor_update", "significant_rework", "restart_required"],
          "description": "Impact on frontend stream"
        },
        "integration_impact": {
          "type": "string",
          "enum": ["none", "minor_update", "significant_rework"],
          "description": "Impact on integration phase"
        },
        "estimated_rework": {
          "type": "string",
          "description": "Estimated rework description"
        }
      }
    },
    "affected_criteria": {
      "type": "array",
      "description": "Acceptance criteria affected by this change",
      "items": {
        "type": "string"
      }
    },
    "reviewed_by": {
      "type": "string",
      "description": "Who reviewed/approved/rejected (if not auto-approved)"
    },
    "review_notes": {
      "type": "string",
      "description": "Notes from the reviewer"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "resolved_at": {
      "type": "string",
      "format": "date-time"
    }
  },
  "example": {
    "id": "CR-AUTH-001-1",
    "feature_id": "AUTH-001",
    "contract_version": 1,
    "requested_by": "backend",
    "change_type": "minor",
    "auto_approve": true,
    "status": "approved",
    "changes": [
      {
        "path": "api_contract.actions[0].outputs.errors",
        "operation": "add",
        "description": "Add 'too_many_attempts' error code for rate limiting",
        "after": {
          "code": "too_many_attempts",
          "message": "Too many login attempts. Please try again later.",
          "http_status": 429
        }
      }
    ],
    "justification": "Rate limiting is a security requirement that emerged during implementation. Adding this error code is additive and doesn't break existing contract.",
    "impact_analysis": {
      "backend_impact": "none",
      "frontend_impact": "minor_update",
      "integration_impact": "none",
      "estimated_rework": "Frontend needs to handle new error state - simple addition to error display logic"
    },
    "affected_criteria": [],
    "reviewed_by": "auto",
    "review_notes": "Auto-approved: additive error code, no breaking changes",
    "created_at": "2026-01-23T10:30:00Z",
    "resolved_at": "2026-01-23T10:30:01Z"
  },
  "examples_by_type": {
    "minor_auto_approve": [
      {
        "description": "Add optional field to data shape",
        "change": { "path": "data_shapes.User.fields.avatar_url", "operation": "add", "after": { "type": "string", "optional": true } }
      },
      {
        "description": "Add new error code (additive)",
        "change": { "path": "api_contract.actions[0].outputs.errors", "operation": "add" }
      },
      {
        "description": "Add accessibility improvement",
        "change": { "path": "ui_contract.components[0].accessibility.aria_labels", "operation": "add" }
      },
      {
        "description": "Add optional prop with default value",
        "change": { "path": "ui_contract.components[0].props.testId", "operation": "add", "after": { "type": "string", "required": false, "default": null } }
      }
    ],
    "breaking_requires_approval": [
      {
        "description": "Change action input type",
        "change": { "path": "api_contract.actions[0].inputs[0].type", "operation": "modify", "before": ":string", "after": ":uuid" },
        "breaking_reason": "Frontend form validation and backend action signature must both change"
      },
      {
        "description": "Remove field from data shape",
        "change": { "path": "data_shapes.User.fields.name", "operation": "remove" },
        "breaking_reason": "Frontend may be displaying this field, backend may be returning it"
      },
      {
        "description": "Add required prop to component",
        "change": { "path": "ui_contract.components[0].props.userId", "operation": "add", "after": { "type": "string", "required": true } },
        "breaking_reason": "All usages must now pass this prop, integration must provide it"
      },
      {
        "description": "Change event payload shape",
        "change": { "path": "ui_contract.components[0].events[0].payload", "operation": "modify" },
        "breaking_reason": "LiveView handler expects different payload structure"
      }
    ]
  }
}
