{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Interface Contract",
  "description": "Contract that defines the interface between backend and frontend streams for parallel implementation. Generated in Phase 0 (Contract Definition) and immutable during parallel Phase 1.",
  "type": "object",
  "required": ["feature_id", "version", "api_contract", "data_shapes", "ui_contract", "acceptance_criteria", "created_at"],
  "properties": {
    "feature_id": {
      "type": "string",
      "description": "Feature identifier (e.g., AUTH-001)",
      "pattern": "^[A-Z]+-[0-9]+$"
    },
    "feature_title": {
      "type": "string",
      "description": "Human-readable feature title"
    },
    "version": {
      "type": "integer",
      "description": "Contract version (increments on breaking changes)",
      "minimum": 1
    },
    "locked": {
      "type": "boolean",
      "description": "Whether contract is locked (true during parallel implementation)",
      "default": false
    },
    "locked_at": {
      "type": "string",
      "format": "date-time",
      "description": "When contract was locked for parallel implementation"
    },
    "api_contract": {
      "type": "object",
      "description": "Backend API contract definition",
      "required": ["actions"],
      "properties": {
        "domain": {
          "type": "string",
          "description": "Ash domain module (e.g., Accounts)"
        },
        "resource": {
          "type": "string",
          "description": "Primary Ash resource (e.g., User)"
        },
        "actions": {
          "type": "array",
          "description": "API actions/endpoints",
          "items": {
            "type": "object",
            "required": ["name", "type", "inputs", "outputs"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Action name (e.g., authenticate)"
              },
              "type": {
                "type": "string",
                "enum": ["read", "create", "update", "destroy", "action"],
                "description": "Ash action type"
              },
              "inputs": {
                "type": "array",
                "description": "Input parameters",
                "items": {
                  "type": "object",
                  "required": ["name", "type"],
                  "properties": {
                    "name": { "type": "string" },
                    "type": { "type": "string", "description": "Elixir/Ash type (e.g., :string, :integer, :utc_datetime)" },
                    "required": { "type": "boolean", "default": true },
                    "constraints": { "type": "object", "description": "Validation constraints" }
                  }
                }
              },
              "outputs": {
                "type": "object",
                "description": "Expected outputs",
                "properties": {
                  "success": { "type": "string", "description": "Success return type" },
                  "errors": {
                    "type": "array",
                    "description": "Possible error codes",
                    "items": {
                      "type": "object",
                      "properties": {
                        "code": { "type": "string", "description": "Error code (e.g., invalid_credentials)" },
                        "message": { "type": "string", "description": "User-facing error message" },
                        "http_status": { "type": "integer", "description": "HTTP status code" }
                      }
                    }
                  }
                }
              },
              "liveview_event": {
                "type": "string",
                "description": "LiveView event name that triggers this action"
              }
            }
          }
        },
        "pubsub_events": {
          "type": "array",
          "description": "PubSub events this feature emits",
          "items": {
            "type": "object",
            "properties": {
              "topic": { "type": "string" },
              "event": { "type": "string" },
              "payload_shape": { "type": "string", "description": "Reference to data_shapes" }
            }
          }
        }
      }
    },
    "data_shapes": {
      "type": "object",
      "description": "TypeScript-like type definitions for data structures",
      "additionalProperties": {
        "type": "object",
        "description": "Named type definition",
        "properties": {
          "description": { "type": "string" },
          "fields": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "type": { "type": "string", "description": "Type (string, number, boolean, array, object, or reference)" },
                "optional": { "type": "boolean", "default": false },
                "nullable": { "type": "boolean", "default": false },
                "description": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "ui_contract": {
      "type": "object",
      "description": "Frontend UI contract definition",
      "required": ["components"],
      "properties": {
        "components": {
          "type": "array",
          "description": "Svelte components to implement",
          "items": {
            "type": "object",
            "required": ["name", "props", "states"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Component name (e.g., LoginForm)"
              },
              "path": {
                "type": "string",
                "description": "Component file path relative to assets/svelte/components/"
              },
              "type": {
                "type": "string",
                "enum": ["new", "existing", "modify"],
                "description": "Whether component is new or modification"
              },
              "props": {
                "type": "object",
                "description": "Component props with types",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "type": { "type": "string" },
                    "required": { "type": "boolean", "default": true },
                    "default": { "description": "Default value" },
                    "description": { "type": "string" }
                  }
                }
              },
              "states": {
                "type": "array",
                "description": "UI states this component must handle",
                "items": {
                  "type": "string",
                  "enum": ["loading", "error", "empty", "success", "default", "focused", "disabled"]
                }
              },
              "events": {
                "type": "array",
                "description": "Events this component dispatches",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": { "type": "string" },
                    "payload": { "type": "string", "description": "Reference to data_shapes" }
                  }
                }
              },
              "accessibility": {
                "type": "object",
                "description": "Accessibility requirements",
                "properties": {
                  "aria_labels": { "type": "array", "items": { "type": "string" } },
                  "keyboard_nav": { "type": "boolean" },
                  "focus_trap": { "type": "boolean" }
                }
              }
            }
          }
        },
        "stores": {
          "type": "array",
          "description": "Svelte stores to implement",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "path": { "type": "string" },
              "shape": { "type": "string", "description": "Reference to data_shapes" }
            }
          }
        },
        "liveview_bindings": {
          "type": "array",
          "description": "LiveView <-> Svelte bindings",
          "items": {
            "type": "object",
            "properties": {
              "liveview_assign": { "type": "string", "description": "LiveView assign key" },
              "svelte_prop": { "type": "string", "description": "Svelte component prop" },
              "direction": {
                "type": "string",
                "enum": ["liveview_to_svelte", "svelte_to_liveview", "bidirectional"]
              }
            }
          }
        }
      }
    },
    "acceptance_criteria": {
      "type": "object",
      "description": "Acceptance criteria assigned to streams",
      "required": ["backend", "frontend", "integration", "e2e"],
      "properties": {
        "backend": {
          "type": "array",
          "description": "Criteria testable with backend-only tests",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "scenario": { "type": "string" },
              "given": { "type": "string" },
              "when": { "type": "string" },
              "then": { "type": "string" },
              "test_type": { "type": "string", "enum": ["unit", "integration"] }
            }
          }
        },
        "frontend": {
          "type": "array",
          "description": "Criteria testable with frontend-only tests (mocked backend)",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "scenario": { "type": "string" },
              "given": { "type": "string" },
              "when": { "type": "string" },
              "then": { "type": "string" },
              "test_type": { "type": "string", "enum": ["component", "visual"] }
            }
          }
        },
        "integration": {
          "type": "array",
          "description": "Criteria requiring backend+frontend wired together",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "scenario": { "type": "string" },
              "given": { "type": "string" },
              "when": { "type": "string" },
              "then": { "type": "string" }
            }
          }
        },
        "e2e": {
          "type": "array",
          "description": "End-to-end tests (full system)",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "scenario": { "type": "string" },
              "critical_path": { "type": "boolean", "description": "Is this a critical user path?" }
            }
          }
        }
      }
    },
    "mock_data": {
      "type": "object",
      "description": "Mock data for isolated testing",
      "properties": {
        "backend_responses": {
          "type": "object",
          "description": "Mock API responses keyed by action name",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "success": { "description": "Mock success response" },
              "errors": {
                "type": "object",
                "description": "Mock error responses keyed by error code"
              }
            }
          }
        },
        "frontend_fixtures": {
          "type": "object",
          "description": "Test fixtures for component testing",
          "additionalProperties": { "description": "Fixture data" }
        }
      }
    },
    "file_ownership": {
      "type": "object",
      "description": "Exclusive file ownership for parallel streams",
      "properties": {
        "backend_paths": {
          "type": "array",
          "description": "Paths owned by backend stream",
          "items": { "type": "string" }
        },
        "frontend_paths": {
          "type": "array",
          "description": "Paths owned by frontend stream",
          "items": { "type": "string" }
        },
        "shared_paths": {
          "type": "array",
          "description": "Paths that require integration phase (neither stream touches)",
          "items": { "type": "string" }
        }
      }
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "created_by": {
      "type": "string",
      "description": "Who/what created this contract"
    },
    "agent_assignments": {
      "type": "object",
      "description": "Criteria and file assignments for parallel implementation agents",
      "properties": {
        "domain-agent": {
          "type": "object",
          "description": "Ash resources, actions, validations, policies",
          "properties": {
            "criteria": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Acceptance criteria IDs assigned to this agent"
            },
            "files": {
              "type": "array",
              "items": { "type": "string" },
              "description": "File paths this agent owns (glob patterns)"
            },
            "dependencies": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Other agents that must complete first"
            }
          }
        },
        "api-agent": {
          "type": "object",
          "description": "LiveView handlers, events, API endpoints",
          "properties": {
            "criteria": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Acceptance criteria IDs assigned to this agent"
            },
            "files": {
              "type": "array",
              "items": { "type": "string" },
              "description": "File paths this agent owns (glob patterns)"
            },
            "dependencies": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Other agents that must complete first"
            }
          }
        },
        "ui-agent": {
          "type": "object",
          "description": "Svelte components, stores, UI tests",
          "properties": {
            "criteria": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Acceptance criteria IDs assigned to this agent"
            },
            "files": {
              "type": "array",
              "items": { "type": "string" },
              "description": "File paths this agent owns (glob patterns)"
            },
            "dependencies": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Other agents that must complete first"
            }
          }
        },
        "data-agent": {
          "type": "object",
          "description": "Migrations, seeds, data transforms",
          "properties": {
            "criteria": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Acceptance criteria IDs assigned to this agent"
            },
            "files": {
              "type": "array",
              "items": { "type": "string" },
              "description": "File paths this agent owns (glob patterns)"
            },
            "dependencies": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Other agents that must complete first"
            }
          }
        }
      }
    },
    "pinned_context": {
      "type": "object",
      "description": "Context to reinforce during implementation to prevent drift",
      "properties": {
        "syntax_anchors": {
          "type": "array",
          "description": "Pattern syntax anchors to reload at checkpoints (e.g., svelte5-runes, ash-actions)",
          "items": { "type": "string" }
        },
        "anti_patterns": {
          "type": "array",
          "description": "Anti-patterns to remind about (e.g., react-hooks, oop-classes)",
          "items": { "type": "string" }
        },
        "naming": {
          "type": "object",
          "description": "Naming conventions to enforce",
          "properties": {
            "components": {
              "type": "string",
              "description": "Component naming convention (e.g., PascalCase)"
            },
            "files": {
              "type": "string",
              "description": "File naming convention (e.g., kebab-case)"
            },
            "events": {
              "type": "string",
              "description": "Event naming convention (e.g., noun:verb)"
            },
            "variables": {
              "type": "string",
              "description": "Variable naming convention (e.g., camelCase)"
            }
          }
        }
      }
    },
    "shared_decisions": {
      "type": "object",
      "description": "Initial shared decisions for agent coordination",
      "properties": {
        "initial": {
          "type": "array",
          "description": "Pre-seeded decisions from contract",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "type": { "type": "string", "enum": ["naming", "pattern", "structure", "interface"] },
              "scope": { "type": "string" },
              "decision": { "type": "object" },
              "impacts": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "naming_conventions": {
          "type": "object",
          "description": "Project naming conventions to enforce",
          "properties": {
            "fields": {
              "type": "object",
              "properties": {
                "style": { "type": "string", "default": "snake_case" },
                "timestamps": { "type": "string", "default": "*_at suffix" },
                "booleans": { "type": "string", "default": "is_* or has_* prefix" }
              }
            },
            "events": {
              "type": "object",
              "properties": {
                "style": { "type": "string", "default": "noun:verb" }
              }
            },
            "components": {
              "type": "object",
              "properties": {
                "style": { "type": "string", "default": "PascalCase" }
              }
            },
            "files": {
              "type": "object",
              "properties": {
                "svelte": { "type": "string", "default": "kebab-case.svelte" },
                "elixir": { "type": "string", "default": "snake_case.ex" }
              }
            }
          }
        }
      }
    },
    "watcher_config": {
      "type": "object",
      "description": "Configuration for QA watcher agents",
      "properties": {
        "format-watcher": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "blocking_at_gate": { "type": "boolean", "default": true },
            "auto_fix": { "type": "boolean", "default": true }
          }
        },
        "lint-watcher": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "blocking_at_gate": { "type": "boolean", "default": true }
          }
        },
        "test-watcher": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "blocking_at_gate": { "type": "boolean", "default": true },
            "coverage_threshold": { "type": "number", "default": 80 }
          }
        },
        "security-watcher": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "blocking_at_gate": { "type": "boolean", "default": false },
            "block_on": {
              "type": "array",
              "items": { "type": "string", "enum": ["critical", "high", "medium", "low"] },
              "default": ["critical"]
            }
          }
        }
      }
    }
  },
  "example": {
    "feature_id": "AUTH-001",
    "feature_title": "User Login",
    "version": 1,
    "locked": true,
    "locked_at": "2026-01-23T10:00:00Z",
    "api_contract": {
      "domain": "Accounts",
      "resource": "User",
      "actions": [
        {
          "name": "authenticate",
          "type": "action",
          "inputs": [
            { "name": "email", "type": ":string", "required": true, "constraints": { "format": "email" } },
            { "name": "password", "type": ":string", "required": true, "constraints": { "min_length": 8 } }
          ],
          "outputs": {
            "success": "User",
            "errors": [
              { "code": "invalid_credentials", "message": "Invalid email or password", "http_status": 401 },
              { "code": "account_locked", "message": "Account is locked. Try again later.", "http_status": 403 }
            ]
          },
          "liveview_event": "authenticate"
        }
      ]
    },
    "data_shapes": {
      "User": {
        "description": "Authenticated user",
        "fields": {
          "id": { "type": "string", "description": "UUID" },
          "email": { "type": "string" },
          "name": { "type": "string", "optional": true }
        }
      },
      "LoginCredentials": {
        "description": "Login form data",
        "fields": {
          "email": { "type": "string" },
          "password": { "type": "string" }
        }
      }
    },
    "ui_contract": {
      "components": [
        {
          "name": "LoginForm",
          "path": "features/auth/LoginForm.svelte",
          "type": "new",
          "props": {
            "onSubmit": { "type": "(credentials: LoginCredentials) => void", "required": true },
            "loading": { "type": "boolean", "required": false, "default": false },
            "error": { "type": "string | null", "required": false, "default": null }
          },
          "states": ["default", "loading", "error"],
          "events": [
            { "name": "submit", "payload": "LoginCredentials" }
          ],
          "accessibility": {
            "aria_labels": ["email input", "password input", "submit button"],
            "keyboard_nav": true,
            "focus_trap": false
          }
        }
      ],
      "liveview_bindings": [
        { "liveview_assign": "error", "svelte_prop": "error", "direction": "liveview_to_svelte" },
        { "liveview_assign": "loading", "svelte_prop": "loading", "direction": "liveview_to_svelte" }
      ]
    },
    "acceptance_criteria": {
      "backend": [
        {
          "id": "AC-1",
          "scenario": "Valid credentials",
          "given": "a registered user exists",
          "when": "authenticate is called with correct email and password",
          "then": "returns the user",
          "test_type": "unit"
        },
        {
          "id": "AC-2",
          "scenario": "Invalid credentials",
          "given": "a registered user exists",
          "when": "authenticate is called with wrong password",
          "then": "returns invalid_credentials error",
          "test_type": "unit"
        }
      ],
      "frontend": [
        {
          "id": "AC-3",
          "scenario": "Form validation",
          "given": "the login form is displayed",
          "when": "user submits with empty fields",
          "then": "shows validation errors",
          "test_type": "component"
        },
        {
          "id": "AC-4",
          "scenario": "Loading state",
          "given": "the form is submitting",
          "when": "loading prop is true",
          "then": "shows loading indicator and disables form",
          "test_type": "component"
        }
      ],
      "integration": [
        {
          "id": "AC-5",
          "scenario": "Full login flow",
          "given": "user is on login page",
          "when": "they enter valid credentials and submit",
          "then": "they are redirected to dashboard"
        }
      ],
      "e2e": [
        {
          "id": "E2E-1",
          "scenario": "Login success path",
          "critical_path": true
        }
      ]
    },
    "mock_data": {
      "backend_responses": {
        "authenticate": {
          "success": { "id": "uuid-123", "email": "test@example.com", "name": "Test User" },
          "errors": {
            "invalid_credentials": { "error": "invalid_credentials", "message": "Invalid email or password" }
          }
        }
      },
      "frontend_fixtures": {
        "validCredentials": { "email": "test@example.com", "password": "password123" },
        "invalidCredentials": { "email": "test@example.com", "password": "wrong" }
      }
    },
    "file_ownership": {
      "backend_paths": [
        "lib/*/resources/user.ex",
        "lib/*/actions/authenticate.ex",
        "test/*/user_test.exs"
      ],
      "frontend_paths": [
        "assets/svelte/components/features/auth/",
        "assets/svelte/stores/auth.ts",
        "assets/svelte/**/*.test.ts"
      ],
      "shared_paths": [
        "lib/*_web/live/auth_live.ex"
      ]
    },
    "created_at": "2026-01-23T09:30:00Z",
    "created_by": "vibe-contract-generator",
    "agent_assignments": {
      "domain-agent": {
        "criteria": ["AC-1", "AC-2"],
        "files": ["lib/*/resources/user.ex", "lib/*/actions/authenticate.ex", "test/*/"],
        "dependencies": []
      },
      "ui-agent": {
        "criteria": ["AC-3", "AC-4"],
        "files": ["assets/svelte/components/features/auth/", "assets/svelte/stores/auth.ts"],
        "dependencies": []
      },
      "data-agent": {
        "criteria": [],
        "files": ["priv/repo/migrations/"],
        "dependencies": []
      },
      "api-agent": {
        "criteria": ["AC-5"],
        "files": ["lib/*_web/live/auth_live.ex"],
        "dependencies": ["domain-agent", "ui-agent"]
      }
    },
    "watcher_config": {
      "format-watcher": { "enabled": true, "blocking_at_gate": true, "auto_fix": true },
      "lint-watcher": { "enabled": true, "blocking_at_gate": true },
      "test-watcher": { "enabled": true, "blocking_at_gate": true, "coverage_threshold": 80 },
      "security-watcher": { "enabled": true, "blocking_at_gate": false, "block_on": ["critical"] }
    }
  }
}
